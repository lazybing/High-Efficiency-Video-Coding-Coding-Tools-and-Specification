# 编码结构

在本章和接下来的第 5 章中，将解释 HEVC 比特流和解码的 HEVC 视频序列的一般结构。图片类型和将编码图片划分为不同类型的单元和块指定了用于表示编码视频序列的空间和时间结构。虽然本章重点讨论图像之间的关系以及用于表示编码图像的空间结构，但第 5 章讨论了位流中编码数据的高级语法和组织。由于时空结构和编码表示之间的强相互关系，本章中仍然提到了比特流表示的一些方面。这里使用的术语包括 NAL（网络抽象层）单元、视频参数集(VPS)、序列参数集(SPS)和图片参数集(PPS)。第 5 章对此作了进一步的详细说明。

为了在比特流中以编码形式表示视频序列，可以使用灵活的时间编码结构，如第4.1节所述。这些编码结构描述了待编码图片的编码顺序，相对于图像最终被安排用于输出(例如到屏幕 1)的输出顺序。选择的编码结构影响编码视频序列的结构延迟，即，以输出顺序在图像之前但以编码顺序在图像之后的最大图像数。该数字也称为最大延迟增加，并在 VPS 和 SPS 中表示为编码视频序列的特征。

第 4.2 节详细介绍了将单个图像组织为单元和块的过程。图像被分割成一个或多个 slice，其中每个 slice 可以由一个或多个 slice segments 组成。slice segments 被组织成编码单元、预测单元和变换单元，他们一起包含 slice 样本块的编码表示。HEVC 中规定了三种不同的 slice 类型，允许仅帧内编码(I slice)、使用一个参考图像列表的帧内编码和预测编码(P slice)以及使用两个参考图像列表的帧内编码和预测编码(B  slice)。图像可以被分割成块，这些块改变了图像组成的块和单元的编码顺序。第 4.2.3 节讨论了 slice 和 tile 的相互作用。

## 4.1 时域编码结构

给定数量图像的视频可分为一个或多个编码视频序列(CVC，见第3.5.1.2节)。相同码流中的每个 CVS 都可以独立解码。在本节中，重点是单个编码视频序列以及编码视频序列中图片在编码顺序和输出顺序方面的组织。图片的输出顺序是生成图片的顺序，以及输出图片以供显示的顺序，以类似于预期视觉印象的原始输入序列的图片顺序。在 SPEC 中，输出顺序由图片顺序技术(POC)表示，其唯一地标识编码视频序列内的图片。注意，在整个 CVS 中，两个连续图片之间的 POC 距离不需要恒定。只需沿着输出顺序严格增加，更全面的讨论见第 5.4.1 节。

编码顺序指定在解码器处重建图片的顺序，并由此定义哪些图片可用于参考。显然，只有先前解码的图片才能被参考，进行预测。图片之间的相关性决定了编码视频序列的编码结构。编码结构包括序列中具有特定编码顺序的连续图片集，定义了包含的图片之间的依赖关系。完整的视频序列可以由该编码结构的周期性重复来表示。编码结构中包含的图片集通常成为图片组(GOP)。在 HEVC 规范的上下文中，此集合称为图片结构(SOP,Structure of Picture)。在本文中，我们将使用先前确定的术语 GOP。

有时，按照编码顺序的 GOP 的第一个图片被称为 GOP 的锚图片或关键图片。请注意，本规范中未使用这些术语以及术语组图片。然而，他们在文献中通常用于描述此类编码结构。

在图 4.1 中，提供了具有不同编码顺序和输出顺序的两个示例编码结构。两种编码结构的 GOP 大小为 8 涨图片，GOP 的关键图片用深灰色标记。图 4.1a 显示了一种编码结构，其中 GOP 的所有图片都是根据过去的编码图片进行预测的(从预测参考到预测目标的所有箭头都指向未来图片)。由于在输出顺序中没有从任何编码图片到未来图片的依赖性，因此图片的编码顺序实际上对应于输出顺序，即图片的显示顺序。在给定的示例中，每个图片的编码顺序实际上对应于输出顺序，即图片的显示顺序。在给定的示例中，每个图片使用单个参考图片进行预测。来自单个参考的预测称为单预测。历史上，这样的图片被称为 P 图片。编码结构进一步展示图片的特定层次。例如，具有奇数输出号码的图片可以在不影响其他图片的可解码性的情况下被丢弃。其他图片的编码结构独立于这些图片。类似地，每四幅图片可以在不受中间图片影响的情况下解码，中间图片的输出数为偶数。这种结构称为分层编码结构。在仅使用P图片的给定示例中，编码结构被称为分层P结构。应当注意，单预测当然可以指包括用于预测的多个参考图片的参考图片列表。但是，对于每个块，只能使用一个参考图片。

图 4.1b 提供了一个编码结构示例，其中包括来自过去图片和未来图片的预测箭头。对于这种编码结构，编码顺序不同于输出顺序，即一些图片需要存储，直到它们被输出。这导致了前面描述的结构延迟。具有来自过去和未来的参考的编码结构通常与双预测一起使用，其中对图片的预测由两个参考的组合形成。这些图片被称为 B 图片。与 P 图片示例一样，所提出的结构展示了预测层次结构，其中预测相关性被嵌套，使得可以丢弃某些图片而不影响其他图片的可解码性。这种结构称为“分层 B 编码结构”。图 4.2 按编码顺序显示了图 4.1b 的编码结构。

编码结构的连续 GOP 之间可能存在预测关系。这种预测相关性的一个例子如图 4.1b 所示。这种结构称为开放式 GOP 编码结构：一个 GOP 的图片来自不同 GOP 的参考图片。省略连续 GOP 之间相互依赖的结构称为闭合 GOP 编码结构。图 4.3 给出了这种编码结构的示例。这里所示的结构包括 I 图片(仅帧内编码)、P 图片和 B 图片，并且类似地用于 H.262|MPEG-2或 MPEG-4 视频中的编码。

HEVC SPEC 包括SEI消息（补充增强信息，请参阅第5.5 节）。编码器可用于描述所用GOP结构的“图片结构”，包括相应的图片类型、适用的参考图片集以及GOP中图片之间的时间关系。

### 4.1.1 时域层

在 HEVC 中，最基本的 SPEC 中提供了与 H.264|AVC Annex G[4, 5]中用于时间可伸缩性的时间层概念非常相似的时间层概念。每个图片都有一个相关联的时间级别标识符 t<sub>id</sub>。随机访问图片被指定为始终具有t<sub>id</sub> = 0。利用时间层的概念，可以通过丢弃 t<sub>id</sub> 大于选定值得所有 NAL 单元，简单地给定视频序列中提取时间分辨率较低的编码视频序列。

此外，时间嵌套的特征可以在 VPS 和 SPS 中指示。如果指示了时间嵌套，则 t<sub>id</sub>较低的图片不得在 GOP 内引用  t<sub>id</sub> 较高或相等的图片进行预测。此外，在激活时间嵌套的情况下，始终可以将解码从较低的时间级别切换到较高的时间级别(即，从较低时间分辨率的任何解码图片开始切换到较高的时间分辨率)。

图 4.4 显示了带有时间嵌套的编码结构示例。在本演示中，图片根据其时间层垂直排列，以便于识别预测关系。由于 t<sub>id</sub> 较低的图片不依懒于 t<sub>id</sub> 较高的图片，因此可以在任何图片的时间层之间切换解码。例如，图 4.4a 中的编码结构允许在60/30/15/7.5Hz 之间切换，而图 4.4b 中的结构允许60/20和10Hz的输出速率。

### 4.1.2 图片类型

图片类型表示给定图片在编码视频序列中的角色。图片类型由编码视频数据的 NAL 单元类型指示。HEVC 指定了四类图片类型：

* 随机接入点图片
* 主要图片
* 时间子级访问图片
* 尾随图片

对于每个类型，都可以指示一组变体。这种变化在最高可能级别(即 NAL unit 头)上提供了比特流的组织和编码结构的明确指示。它包括关于当前图片的信息，但可以进一步提供关于与当前图片相关联的其他图片的信息。此类信息可用于比特流的外部处理和解析（例如，媒体感知网络元件、MANEs）。

图片类型通过允许或不允许某些 slice 类型对可用的预测方法施加约束。下面详细介绍图片类型、它们的约束以及它们在不同场景中的用法。

#### 4.1.2.1 随机接入点

术语随机接入点(RAP)表示该图片类型的主要特征：解码可以在这些图片处开始(具体地，在包含图片片段的接入单元处)。 RAP 图片只包含 I slices，即只有帧内预测应用到这类编码图片中。因此，随机接入点图片由首字母缩略词 RAP (用于内部随机接入点)表示。

当 RAP 图片的解码开始时，要求解码器可以使用相应的 VPS、SPS和PPS。下面详细介绍了提供随机接入点功能的图片类型。

**即时解码器刷新图片：IDR**

IDR 图片重置解码过程，并始终启动新的编码视频序列。如果在解码器处接收到 IDR 图片，则在 IDR 图片的解码开始之前重置解码图片缓冲器。因此，只能从按编码顺序在 IDR 图片之后的图片中参考 IDR。按编码顺序排列在 IDR 之前的图片将被删除，因此无法用于预测。IDR 的概念已经在 H.264/AVC 中使用过。

由于 IDR 启动新的编码视频序列，POC 值重置为零。应当注意，在具有仅帧内编码的应用中，建议不要将所有图片标记为 IDR，因为使用 POC 检测 NAL 单元流种的接入单元的边界的能力将丢失。

**Clean Random Access Picture: CRA**

与 IDR 相反，CRA 图片不重置参考图片缓冲区，并且不一定启动新的编码视频序列。因此，在解码编码视频序列中，CRA 可能出现在编码视频序列中。CRA 类型指示解码过程可以从当前图片开始。解析比特流时，检测到的 CRA 图片指示解码视频序列的潜在入口点。在这样的新开始之后的解码结果被断言为符合针对输出顺序跟随 CRA 图片的图片的 SPEC。此属性通过限制 CRA 后面的图片（编码和输出顺序）不使用 CRA 前面的图片作为参考来实现。

NAL 单元流可能包含“以编码顺序在 CRA 之后，但以输出顺序在 CRA 之前”的图片。这类图片可以在编码顺序中包含对当前 CRA 之前的图片的进一步引用，因此可能不可解码（至少在没有由于缺少或错误引用而导致重建质量严重降低的情况下）。下一小节将讨论相应的图片类型和处理这些问题的方法。

如果 CRA 图片不是在视频序列的最开始出现，而是在编码视频序列中出现的，则将其作为编码在 NAL 单元流种的编码结构的一部分解码。CRA 图片特别适用于“开放 GOP”编码结构。图 4.5 给出了此类结构的示例。

**Broken Link Access Picture:BLA**

BLA 图片对于比特流拼接操作非常有用，请参见第 4.1.3 节。BLA 标识最初并不打算编码到比特流中，但可以应用于 CRA 以指示此时两个序列的串联。为此，仅需要修改 NAL 单元类型，以指示从 CRA 到 BLA 的切换。此更改不会影响图片本身，但可能会影响后续图片的编码顺序。

如前所述，视频序列的解码可以从 CRA 图片处开始。然而，如果将一个序列拼接到另一个序列，则可能会发生以下情况：以解码顺序跟随 CRA 的图片参考原始序列的图片，这些图片在拼接到新序列后不再可用。现在，来自拼接序列的图片可能以与拼接操作之前的前一流中的图片相同的参考图片索引驻留在解码图片缓冲区中。BLA 表示不应显示带有此类参考的图片。否则，这些图片可能指的是不同于编码器最初可用的图片，因此重建的图片可能不适合显示。

## 4.2 空间编码结构

本节中，介绍了视频序列图片的可用分区方法，并介绍了特定区域的术语。

对于编码，图片被分割成方形的编码数块(CTB)。一组连续的编码树块被分组到一个 slice 中。CTB 具有每个编码视频序列的可配置大小，并取代了 ISO/IEC 和 ITU-T 先前标准和建议中使用的“宏块”。slice 的基本概念也继承了以前的标准。然而，在 HEVC 中，一个 slice 可以分割成多个segments，这些segments以单独的 NAL 单元编码。CTB 是编码块树的根，这些编码块又被进一步划分用于预测和残差的变换编码。图片中的块和 slices的组织可以进一步受到 tiles 概念的影响，tiles 修改了 CTB 的固定光栅扫描顺序。

在下文中，在介绍了块和单元的关系之后，从图片级到预测和变换块详细描述了空间编码结构。

## 4.3 参考图像

解码图片存储在解码图片缓冲器（DPB）中。DPB中的图片可以用作参考图片或存储，直到输出为止。HEVC 规范区分三种类型的图片：用于短期参考的图片、用于长期参考的图片和未用于参考的图片。在参考图片集(RPS)中收集编码视频序列的当前或未来图片中用于预测的图片。RPS 中未包含的所有图片都标记为未使用以供参考。一旦达到输出时间，这些图片将从 DPB 中删除。

HEVC SPEC 区分了参考图片集合参考图片列表。参考图片集包括当前或未来图片中为潜在预测而保存的所有图片，但参考图片列表包含当前图片中实际用于预测的图片。参考图片列表被构造为参考图片集的子集。参考图片列表中实际使用的图片数量可以在 slice 的基础上进行控制。

### 4.3.1 参考图像集

参考图片集是可用于编码图片的帧间预测的先前解码图片的集合。参考图片集中的参考图片通过其 POC 值明确标识。在开始解码图片之前，为图片中的所有 slice 构造一次合适的参考图片集。DPB 缓冲区中的图片，可以包括在参考图片集中，并且可以在当前图片中或在解码顺序的后续图片中用作参考。如果 RPS(Reference Picture Set)中未包括图片，则将其标记未“未用于参考”，并可在输出后从 DPB 中删除。

HEVC Spec 允许在 SPS 中发送预定义的RPS(Reference Picture Set)。然后，通过索引指定当前 slice 的合适集，索引进入 slice segment header 中的预定义参考图片集列表。此外，额外的 RPS 可以在 slice segment header 中显式地发信号。由于 RPS 在 每个 slice segment header 中被指示，因此可能需要在每个对应的报头中重复 RSPS 的显式信号。

从概念上讲，RPS 中区分了两种类型的参考图片，Short-Term Reference 和 Long-Term Reference。Short-Term RPS 被设计为在当前图片的时间接近范围内提供对图片的参考，例如，在图片的相同结构内。

Long-Term RPS 可用于为长期参考目的对选定图片进行选址。这些Long-Term RPS 独立于 short-term 图片集构建。该语法允许最多 32 张图片，可指定用于 SPS 中的长期预测。在 HEVC 的主要配置文件中，Long-Term RPS 的最大数量限制为 15 张。与 short-term 图片集类似，长期参考图片集可在 slice header 中发送信号，以供在当前 slice 中特定使用。slice header 中发信号的长期参考图片的可能数量由解码图片缓冲器的剩余大小确定。

为了构建合适的参考图片集，导出了五个子集。参考图片对其中一个子集的分配由其 POC 值相对于当前图片的 POC 值的关系确定。short term 图片按小于当前短期之前的 POC 值、大于当前短期之后的 POC 值进行分类，不在当前图片中使用，但保存在 DPB 中，以便在未来图片(短期后续)中用作参考。长期图片分为当前图片中使用的图片(“当前长期”)和未在当前图片中使用，但后续图片中使用的图片(“长期后续”)。这些子集用于参考图片列表的构建过程。

如前所述，DPB 中不在这些列表之一中的图片被标记未未使用以供参考，并且可以从缓冲器中删除。DPB 中的每幅图片都可以在五个子集中的一个子集中列出，也可以布列出。

由于合适的参考图片集在每个 slice segment header 中被指示，并且来自 DPB 的属于参考图片集的图片通过其唯一 POC 值来识别，因此当前参考图片集的构造不依赖于先前图片中的集合的构造。此外，如果 DPB 中没有具有所请求的 POC 值的图片可用于构建当前参考图片集，则解码器具有发送传输损耗的明确指示。因此，显示 RPS 信令和绝对 POC 指示提高了编码方案的错误鲁棒性。



