# 第五章 High-Level 语法

本章详细介绍了包含编码视频序列的比特流的高级语法和高级组织。第四章描述了编码结构的时空关系和组织，而本章讨论了语法元素及其语义的表示。

高级语法为编码视频数据提供封装，以便进一步处理。它构建了用于传输的信息，并使其可访问和可搜索。它还提供了对所有指定的高级参数和附加辅助信息进行编码的方法。为了在编码信息和表示该信息的形式之间分离，定义了视频编码层(VCL)和网络抽象层(NAL)。所有 VCL 和 非 VCL 数据都封装在 NAL 单元中进行传输。下面将进一步详细介绍这些概念。高级语法方案在概念上继承了H.264 | AVC，并进行了一些修订和扩展，以匹配修改后的需求并实现改进的功能。

## 5.1 Byte Stream Format

与 H.264 | AVC  一样，HEVC 规范提供了一种自包含的字节流格式，用于表示 NAL 单元流。字节流格式在 HEVC 附录 B 中规定。该格式可用于将编码视频数据传输到文件或从文件中传输、或通过网络传输。如果传输层提供其他方式来封装原始 NAL 单元数据，则不需要使用字节流格式。不适用字节流格式的另一种传输类型是实时传输协议(RTP)的有效负载格式。本章提供了HEVC 系统层集成的概述。

在字节流格式中，NAL 单元被编码成字节流。为了使解码器能够从该流中检测和提取 NAL 单元，字节流格式在字节流中的每个 NAL 单元之前指定一个起始代码前缀。起始代码前缀由三个字节(两个零字节和一个'1'字节)组成：start code prefix = 0x00 0x00 0x01 = 0000 0000 0000 0000 0000 0001

如果 NAL 单元是编码视频序列中第一个访问单元的第一个 NAL 单元，或者如果 NAL 单元包含参数集，则在开始代码之前插入额外的 0x00 字节。

如第 5.2.1 节所述，编码器必须防止在字节流的字节对齐位置出现起始代码前缀的字节序列。如果编码数据将产生此字节序列，则插入模拟预防字节。通过扫描字节流中的起始代码前缀，解码器可以确定每个 NAL 单元的起始字节位置，并通过检测最终的尾随零字节，确定 NAL 单元的总大小Nu(以字节为单位)。

## 5.2 Network Abstraction Layer

NAL 定义了用于传输和存储的编码视频数据的封装。编码信息以 NAL 单元组织，NAL 单元包含视频编码层(VCL)的数据或非 VCL 数据。视频编码层包括所有 slice 和 CTU 数据。非 VCL 数据包括参数集和其他信息，详情如下。

表示编码视频序列的所有 VCL 和 non-VCL NAL 单元的有序集合称为 NAL 单元流。根据上下文，NAL 单元流或根据字节流格式的字节流，也称为比特流。

### 5.2.1 NAL Unit Structure

NAL 单元(NALU)的有效负载是 Nu 字节序列。前两个字节包含 NAL 单元头，其余字节称为原始字节序列有效负载(RBSP)。包含编码数据的 RBSP的最后一个字节包括 RBSP 停止位("1")和("0")位，以便实现字节对齐。RBSP 停止位之前的 RBSP 字节位的串联构成数据位串(SODB)。SODB 包含解码过程所需的所有编码数据。在 SODB 中，字节的位从 MSB 连接到 LSB。图 5.1 给出了NAL 单元字节(包括 RBSP 和 SODB)的图示。

SPEC 要求 SODB 断言字节对齐重新同步的能力。因此，可以在比特流中扫描起始码，以找到下一个 NAL 单元的字节对齐的开始。为防止出现起始码，编码器必须在字节对齐位置扫描 RBSP 以查找以下二进制模式：0000 0000 0000 0000 0000 00xx ，其中xx = {00, 01, 10, 11}。然后，必须使用值为'3'的开始代码模拟预防字节修改这些二进制模式：0000 0000 0000 0000 0000 0011 0000 00xx。

根据 SPEC，在 NAL 单元中这样的仿真防止字节可以出现的最早位置是第五个字节(即，在 NAL 单元报头之后的三个字节)。编码器必须声明，考虑到 NAL 单元头的内容，不会发生起始码仿真。

NAL 单元中的字节数 Nu 包含了仿真预防字节。考虑到 RBSP 字节的数量，当从 RBSP 提取 SODB 时，由于这些字节在解码器侧被移除，因此仿真预防字节被排除。解码器必须知道 RBSP 中的字节数，因为它用于停止 slice 级别的熵解码。

NAL 单元头标识 NAL 单元类型及其余其他 NAL 的关系。NAL 单元头的结构如图 5.2 所示。它由两个字节组成。在符合 SPEC 的比特流中，第一位的值必须为零，后面跟着 6 bit 指示单元类型。接下来的 6 bit 是为 layer 标识符保留的。该标识符将在 HEVC 扩展中用于可伸缩视频编码和多视图编码。在 HEVC spec 的版本 1 中，要求 lid = 0。头的最后三位被分配给临时标识符 t<sub>id</sub>。tid 表示将 NAL 单元分配给视频序列的特定时间层，见第 4.1.1 节。对 non-VLC NAL 单元，NAL 单元头中的 tid 表示 NAL 单元内容适用的最低时间层。

为了提供对 NAL 单元内的各种高级信息的访问，在 NAL 单元中的固定比特位置处指定用于某些 NAL 单元类型的报头以及一些其他信息，其还可以是字节对齐的。此概念使媒体感知网元(MANEs)能够轻松解析和访问这些信息以供其应用程序使用。

### 5.2.2 NAL Unit type

与 H.264 | AVC 相比，可用 NAL 单元类型的数量已从32 扩展到 64 个。引入此扩展是为了防止将来的扩展缺少可用的 NAL 单元类型。

SPEC 中规范了各种 NAL 单元类型，以对 NAL 单元中包含的信息进行分类。表 5.1 中提供了可用 NAL 单元类型列表。NAL 单元类型可分为两类：视频编码层(VCL) NAL 单元和非 VCL NAL 单元。VCL 类型包括包含实际编码视频数据的所有 NAL 单元。non-VCL 类型包含参数集、分隔符、补充增强信息或填充数据。对于这两个类，都指定了保留的 NAL 单元类型，这些类型可以再 spec 的未来扩展中使用。 NAL 装置类型48、...、63未使用，在 HEVC 规范的未来版本中也将保持 unsepecified 状态。该数字范围可用于专用的外部需求，如新型的 HEVC0 RTP 有效载荷格式。

VCL NAL 单元包含一个 slice 的编码视频数据，该slice 对应于图片定义区域中的一组 CTU。属于同一图片的所有 VCL NAL 单元(因此属于同一访问单元，见下文)必须具有相同的 NAL 单元类型。因此，NAL 单元类型指定图片类型。除了关于图片类型的信息外，NAL 单元类型还提供了关于其它 VCL NAL 单元对当前 NAL 单元的依赖关系的附加信息。以下将重点介绍其中一些方面。

对于不提供随机访问功能的 NAL 单元类型0、...、15,NAL 单元类型的奇偶校验分表表示当前图片在其他图片中的用作或未用作参考。被标记为非参考的 NAL 单元对应于不包括在参考图片列表中的图片。对于与指定的随机接入点图片类型相对应的 NAL 单元类型16、...、21,特定 NAL 单元类型指示是否存在相关联的前导图片。进一步指示如果在随机接入点处开始解码，则这些前导图片是否都是可解码的，或者如果在这里开始解码，则前导图片集是否包括需要跳过的图片。

non-VCL NAL 单元类型包括VPS、SPS 和 PPS，这些参数集包括配置文件/级别信息以及工具配置的所有参数，详情如下。此外，SEI信息以 non-VCL NAL 单元承载。对于 SEI 消息，NAL 单元类型的奇偶性指示 SEI 消息是否需要在接入单元中的最后一个 VCL NAL 单元之前发送(prefix SEI 消息)，或者是否需要在第一个 VCL NAL 单元之后发送(并且可能在最后一个 VCL NAL 单元之后，suffix SEI message)。通常，解码过程不需要 SEI 消息，但对于解码器确定比特流的属性(尤其是在数据丢失的情况下)或传送附加的旁侧信息可能非常有帮助。

提供特定的 NAL 单元类型，用来指示接入单元的边界、视频序列的结束或比特流的结束。虽然此类信息可以从可用的 NAL 单元及其在 NAL 单元流中的顺序中获得，但这些 NAL 单元类型的可用性在无法执行此类分析的系统中是有价值的。

EOS（序列结束）和EOB（比特流结束）NAL 单元除了其终止指示之外，不传送进一步的特定信息。访问单元定界符表示新访问单元的开始，并指示访问单元是仅包含 I slice，或 I Slice 和 P Slice，或是否可能包含 I、P 和 B Slice。

为填充数据定义了一种特殊的 NAL 单元类型。此类型的 NAL 单元可能包含任意数量的 0xFF 字节。例如，对避免缓冲区下溢有严格要求或要求以规定的固定比特率提供视频的系统可以使用填充数据 NAL 单元。

### 5.2.3 Access Units

在前面的章节中，讨论了图片及其属性。这种方法是直观的，因为显示的图片序列构成了可感知的视频。在 NAL 单元和比特流的组织方面，图片的概念没有直接应用。相反，引入了接入单元(Access Units, AUs)的概念。与由 VCL 数据构成的图片相反，访问单元是一组 NAL 单元，包括 VCL 和 non-VCL NAL 单元。

序列中的每个编码图片包含在一组（一个或多个）NAL单元中。访问单元包含与一张图片相关联的所有 NAL 单元。访问单元中的所有 NAL 单元(VCL 和 non-VCL)共享所包含图片的输出时间。注意，根据 SPEC，比特流中的所有 NAL 单元都与访问单元相关联，并且访问单元必须包含编码图片。因此，完整的 NAL 单元流可以被视为接入单元流。

前面章节中讨论了可用图片类型集。这些类型也可用于寻址访问单元。即 BLA 图片包含在 BLA 访问单元中，等等。如上所述，一个 AU (access unit) 内的所有 VCL NAL 单元必须具有相同的 NAL 单元类型。这并不一定意味着它们需要在一张图片中具有相同的 slice 类型。

图 5.3 给出了接入单元中 NAL 单元组织的可视化。SPEC 中也提供了类似的图。AUD（Access Unit Delimiter）可用于指示新访问单元的开始。如果存在，该 NAL 单元必须是接入单元中的第一个 NAL 单元。Prefix SEI NAL 单元可能包含一个或多个 SEI 消息。这些 NAL 单元可能出现在编码 slice  NAL 单元之前，或与编码 Slice NAL Unit 交织，但不得在最后一个 VCL NAL Unit 之后。相反，suffix NAL 单元跟随在 VCL NAL 单元之后。这些不得位于第一个 VCL NAL 单元之前。此外，通过 AUD 指示接入单元的开始的选项、编码视频序列的结束或完整比特流的结束可以分别由 EOS和 EOB NAL 单元指示。这种明确的高级信号可用于解除解码器对相应信息的检测和识别。

AU(Access Unit)中的VCL NAL 单元都需要具有相同的时间标识符tid，该时间标识符 tid 同时是接入单元的 tid。如果数据持续存在并且应用于不同时间层的比特流中的稍后接入单元，则 non-VCL 单元的 tid 可以与当前 AU 中 tid 不同(更高)。例如，这适用于在比特流中发送以供以后激活的PPS或SEI消息。

### 5.2.4 Decoding Units

对于极低延迟应用，引入了解码单元(DU,Decoding Units)的概念。每个 DU 单元由接入单元内的 NAL 单元的子集组成。解码单元的有序集合构成访问单元。当接入单元对应于解码图片时，解码单元对应于解码子图片(例如，独立片段及其相关联的从属 slice segments,即一个或多个 NAL 单元)。

如果使用，则在子画面的基础上驱动假设参考解码器的操作。由于解码处理也在子图片的基础上操作，因此可以在全图片被解码之前开始子图片的输出。这种极低延迟的操作在屏幕共享应用中非常有用。

有关 DUs 的使用，请参见第5.6节的 HRD 参数。如果未指示子画面操作(因为 SPS 中部包含 HRD 参数或子画面操作被停用)，则访问单元构成解码单元。

## 5.3 Parameter Sets

参数集的概念有助于构造编码视频序列的高级特征，并在清晰的层次结构中进一步构造序列的高级信息。应用于编码视频序列的多个 slice segments、多个图片或多层的信息彼此分离，并且与编码 slice 数据本身分离。为了再数据丢失的情况下，提高编码视频序列表示的错误鲁棒性，设计了这些不同层次的严格分离。通过该方案，可以根据各个层次的需要应用专用保护。从图片级开始，这些信息被组织再专用参数集中，这些参数可以与编码视频数据一起传输，通过单独的(可靠的)通道发送，甚至对于专用应用来说，是写死的并且是不可更改的。因此，即使在部分或严重数据丢失的情况下，也确保解码片段所需的最重要信息可供解码器使用。

HEVC 指定了三个参数集，他们分别是VPS、SPS、PPS。在这些参数集中，其中 SPS 和 PPS 已经出现在 H.264 | AVC 中，HEVC新引入了 VPS。它们的目的是共同提供编码视频序列的不同层和子层的信息。尽管对于 SPEC 之规定的 single level profiles(Main、Main Intra、Main Still Image)，这些参数集的使用可能会受到限制，但它在 HEVC SPCE 的未来扩展(空间和质量的可伸缩性，或用于多视图编码)中会非常有用。

在解码过程中，三个参数集必须在正式解码所编码视频序列的第一个 slice 开始之前就可用。仅在图片的开头处，slice segment 解码处理激活并处理 PPS。PPS在整个图片的解码过程中，处于激活状态。VPS 和 PPS 仅在新的编码视频序列的开始处被激活。因此，如果需要修改这些参数集中的参数，则需要启动新的编码视频序列。如上所述，如果参数集通过其他方式提供(out-of-band 传输)，则不需要与视频数据一起传输。如果在 NAL 单元流中传输，则参数集 NAL unit 的出现标志着新 AU 的开始。因此，参数集必须位于 AU 的第一个，位于访问单元分隔符(如果存在)之后。

出于容错的目的，可以在比特流中发送统一参数集的多个副本。在 NAL 单元流中共享相同的参数集 ID 的参数集必须包含所有语法元素的相同值。如果出于某种原因，需要在不同的时间(或在不同的解码器中)激活参数集的不同副本，则需要此限制以避免冲突。NAL 单元流还可以包含未激活的参数集。然而，编码的所有参数集必须是有效的参数集，遵守 SPEC 的所有约束，包括 profiles 和 Levels。

出于错误和丢失鲁棒性的原因，每个参数集是自包含的，即，可以在不参考NAL单元流中的任何其他NAL单元的情况下对其进行解码。对于VPS和SPS，最重要的信息是在开始时进行固定长度编码，以实现直接和低复杂度访问。所有参数集都包含各种挂钩，以支持将来的扩展性或修改。

参数集的激活遵循分层方法，如图 5.4 所示。PPS 从编码图片的第一个 slice segment header 处激活；如上所述，相同图片中后续 slice 必须引用具有相同内容的 PPS。需要注意的是，这些 PPS 不必具有相同的 PPS 标识符。然而，同一编码视频序列的不同图片很可能通过不同的参数设置激活不同的 PPS。PPS 激活SPS，SPS激活VPS。通过允许多个 PPS 引用同一SPS，多个SPS指向同一VPS，实现了编码视频序列上不同类型高级信息的高效灵活表示。

以下小结简要介绍了三个参数集的内容。描述从 VPS 中的最高级别信息开始，然后移动到 slice segment header 中的最低级别。本演示文稿未包含对所有可能参数的完整讨论，只是指出了其主要特点。有关完整概述，请参考本 SPEC 第 7.3 条和第 7.4 条。

### 5.3.1 Video Parameter Set

VPS 是专门为多层比特流信息而引入的。它提供关于编码视频序列的通用信息，包括一个或多个层的存在，以及可用的操作点；例如，可以从给定比特流提取子比特流来达到这些操作点。

由于VPS是最高层的参数集，所有直接或间接引用特定 VPS 的参数集，必须满足该 VPS 设置的约束。VPS 只能在编码视频序列的开头激活，即 IDR 或 BLA 访问单元，或 CRA 访问单元，它是编码视频序列中的第一个访问单元。

VPS 从一组语法元素开始，这些语法元素在前四个字节的定义位置进行固定长度编码。因此，解码器或外部应用程序可以轻松访问这些语法元素。语法元素集包括 VPS 标识符和关于可用层以及可用时间子层的信息。SPS 使用VPS 标识符激活给定的 VPS。如本书所述，对于单层序列，可用层的数量固定为 1。例如，该语法元素将用于即将推出的 HEVC 可伸缩或多视图扩展中，以分别指示可用(空间或质量)层或视图的数量。时间子层的数量对应于时间标识符 tid 的可用值，详见第 4.1.1 节。此外，对于时间子层，指出了时间嵌套的特性。

前四个字节后面是一个语法结构，其中包含关于解码器可用于给定比特流的可用操作点的信息。操作点以适用的配置文件、层和级别为特征。它指定了解码六可能需要的编码工具的约束以及比特流大小或缓冲区能力的约束，请参见第 11 章。在为整个比特流只当操作点之后，可以为比特流的时间子层指定操作点(如果可用)。同样，这些语法元素是使用固定长度的码字指定的，这些编码的信息继续按字节对齐，以便于解码器或外部应用程序访问。

VPS中的其余信息被认为不需要固定长度的字节对齐访问。这些语法元素的编码部分由可变长度代码指定，以便于高效表示。这些语法元素包括关于子层缓冲和延迟的信息、一般定时信息以及假设参考解码器（HRD）的参数（见第5.6节）

### 5.3.2 Sequence Parameter Set

VPS 包含的 high-level 参数描述了编码视频序列的一般特性；而 SPS 指定编码视频序列中使用的特征和激活工具。与涉及整个比特流的 VPS 不同，SPS 信息仅适用于层表示符号 lid 指定的层。在 SPEC 规范的版本中，只允许 lid = 0， 因此，在这种情况下，VPS 中的某些位流全局信息只需加倍。

SPS 中指定的功能包括编码图片的颜色格式和位深度以及样本分辨率。与 VPS 一样，SPS 在编码视频序列的开头激活一次，该编码视频序列可以是 IDR、BLA 或 CRA 访问单元。

SPS 从 SPS 标识符、时间子层的数量和指示时间嵌套的标志开始。此信息在 SPS 的前两个字节中进行固定长度编码。然后，包括 VPS 部分中描述的操作点语法结构。VPS 中提供的操作点信息包括关于完整比特流的信息，在单层比特流的情况下，该信息将对应于完整的操作点信息。在可扩展和多视图扩展中，可以为每个层或视图激活单独的 SPS。因此，SPS 中的操作点信息指定了仅用于相应图层或视图的参数。

除了上述图片和颜色格式信息之外，参数集还包括适用的工具配置，例如最小和最大编码块大小，即编码树块参数、最小和最大变换块大小以及块间和块内的变换树层次深度。此外，SPS中包括短期和长期参考图片集以及用于编码工具的各种激活标志。

SPS 特别包含了发送视频可用性信息(VUI)的可能性。VUI 参数提供编码视频内容的详细信息，包括颜色空间、色度定位、样本纵横比等，参见第 5.7 节。此外，VUI 包括 HRD 的参数，同时，这些参数将与单层编码 VPS 中的参数相同，但在设想的 HEVC 扩展中使用时可能不同。

### 5.3.3 Picture Parameter Set

如名字所示，PPS包含适用于一张图片的参数。因此在图片级别而不是序列级别上激活图片参数集，并且激活的 PPS 可以在图片之间改变。请再次注意，图片中的所有 slice 都必须引用相同的图片参数集。

PPS包括CABAC的熵编码配置参数、适用的量化器配置、偏移和缩放列表，以及相关切片和波前并行处理的激活。PPS进一步配置当前图片的分片和循环过滤器的配置。由于该规范结构，序列中的分片可以在图片之间改变。可以在VUI中指示恒定磁贴分区的应用。

## 5.4 Slice Segment Header

Slice Segment Header 包含对合适的 PPS 的引用，从而激活参数集链。图片中的所有 slice segment headers 引用具有相同内容的 PPS。这些 PPS　不必具有相同的　PPS　标识符。

Slice Segment Header 包含可能因 slice 而更改的信息。应该注意的是，对于图片中的所有 slice，某些 slice segment header 参数必须相同。独立的 slice segment 头的参数适用于所有关联的从属 slice segments。由于头部包含在每个独立的 slice segment 中，因此可以保证该 slice segment 及其相关联的从属 slice  segment 可以独立于图片的其他 slice 进行解码。

请注意，slice header 包含一个特殊标志，指示当前图片是否应标记为输出。如果该标志设置为零，则图片不会交付显示，当扔存储在解码图片缓冲区中。因此，它可供以后在显示的图片中参考。

除了量化、去块和环路滤波等工具参数外，slice segment header 还包含波前并行处理等信息。应当注意的是，该信息所需的 bits 量可能是重要的。对于非 IDR 图片，slice segment header 还包含POC、short-term 和 long-term 参考图片集的配置以及合适的参考图片列表长度。

