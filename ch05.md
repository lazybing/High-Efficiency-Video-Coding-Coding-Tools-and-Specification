# 第五章 High-Level 语法

本章详细介绍了包含编码视频序列的比特流的高级语法和高级组织。第四章描述了编码结构的时空关系和组织，而本章讨论了语法元素及其语义的表示。

高级语法为编码视频数据提供封装，以便进一步处理。它构建了用于传输的信息，并使其可访问和可搜索。它还提供了对所有指定的高级参数和附加辅助信息进行编码的方法。为了在编码信息和表示该信息的形式之间分离，定义了视频编码层(VCL)和网络抽象层(NAL)。所有 VCL 和 非 VCL 数据都封装在 NAL 单元中进行传输。下面将进一步详细介绍这些概念。高级语法方案在概念上继承了H.264 | AVC，并进行了一些修订和扩展，以匹配修改后的需求并实现改进的功能。

## 5.1 Byte Stream Format

与 H.264 | AVC  一样，HEVC 规范提供了一种自包含的字节流格式，用于表示 NAL 单元流。字节流格式在 HEVC 附录 B 中规定。该格式可用于将编码视频数据传输到文件或从文件中传输、或通过网络传输。如果传输层提供其他方式来封装原始 NAL 单元数据，则不需要使用字节流格式。不适用字节流格式的另一种传输类型是实时传输协议(RTP)的有效负载格式。本章提供了HEVC 系统层集成的概述。

在字节流格式中，NAL 单元被编码成字节流。为了使解码器能够从该流中检测和提取 NAL 单元，字节流格式在字节流中的每个 NAL 单元之前指定一个起始代码前缀。起始代码前缀由三个字节(两个零字节和一个'1'字节)组成：start code prefix = 0x00 0x00 0x01 = 0000 0000 0000 0000 0000 0001

如果 NAL 单元是编码视频序列中第一个访问单元的第一个 NAL 单元，或者如果 NAL 单元包含参数集，则在开始代码之前插入额外的 0x00 字节。

如第 5.2.1 节所述，编码器必须防止在字节流的字节对齐位置出现起始代码前缀的字节序列。如果编码数据将产生此字节序列，则插入模拟预防字节。通过扫描字节流中的起始代码前缀，解码器可以确定每个 NAL 单元的起始字节位置，并通过检测最终的尾随零字节，确定 NAL 单元的总大小Nu(以字节为单位)。

## 5.2 Network Abstraction Layer

NAL 定义了用于传输和存储的编码视频数据的封装。编码信息以 NAL 单元组织，NAL 单元包含视频编码层(VCL)的数据或非 VCL 数据。视频编码层包括所有 slice 和 CTU 数据。非 VCL 数据包括参数集和其他信息，详情如下。

表示编码视频序列的所有 VCL 和 non-VCL NAL 单元的有序集合称为 NAL 单元流。根据上下文，NAL 单元流或根据字节流格式的字节流，也称为比特流。

### 5.2.1 NAL Unit Structure

NAL 单元(NALU)的有效负载是 Nu 字节序列。前两个字节包含 NAL 单元头，其余字节称为原始字节序列有效负载(RBSP)。包含编码数据的 RBSP的最后一个字节包括 RBSP 停止位("1")和("0")位，以便实现字节对齐。RBSP 停止位之前的 RBSP 字节位的串联构成数据位串(SODB)。SODB 包含解码过程所需的所有编码数据。在 SODB 中，字节的位从 MSB 连接到 LSB。图 5.1 给出了NAL 单元字节(包括 RBSP 和 SODB)的图示。

SPEC 要求 SODB 断言字节对齐重新同步的能力。因此，可以在比特流中扫描起始码，以找到下一个 NAL 单元的字节对齐的开始。为防止出现起始码，编码器必须在字节对齐位置扫描 RBSP 以查找以下二进制模式：0000 0000 0000 0000 0000 00xx ，其中xx = {00, 01, 10, 11}。然后，必须使用值为'3'的开始代码模拟预防字节修改这些二进制模式：0000 0000 0000 0000 0000 0011 0000 00xx。

根据 SPEC，在 NAL 单元中这样的仿真防止字节可以出现的最早位置是第五个字节(即，在 NAL 单元报头之后的三个字节)。编码器必须声明，考虑到 NAL 单元头的内容，不会发生起始码仿真。

NAL 单元中的字节数 Nu 包含了仿真预防字节。考虑到 RBSP 字节的数量，当从 RBSP 提取 SODB 时，由于这些字节在解码器侧被移除，因此仿真预防字节被排除。解码器必须知道 RBSP 中的字节数，因为它用于停止 slice 级别的熵解码。

NAL 单元头标识 NAL 单元类型及其余其他 NAL 的关系。NAL 单元头的结构如图 5.2 所示。它由两个字节组成。在符合 SPEC 的比特流中，第一位的值必须为零，后面跟着 6 bit 指示单元类型。接下来的 6 bit 是为 layer 标识符保留的。该标识符将在 HEVC 扩展中用于可伸缩视频编码和多视图编码。在 HEVC spec 的版本 1 中，要求 lid = 0。头的最后三位被分配给临时标识符 t<sub>id</sub>。tid 表示将 NAL 单元分配给视频序列的特定时间层，见第 4.1.1 节。对 non-VLC NAL 单元，NAL 单元头中的 tid 表示 NAL 单元内容适用的最低时间层。

为了提供对 NAL 单元内的各种高级信息的访问，在 NAL 单元中的固定比特位置处指定用于某些 NAL 单元类型的报头以及一些其他信息，其还可以是字节对齐的。此概念使媒体感知网元(MANEs)能够轻松解析和访问这些信息以供其应用程序使用。

### 5.2.2 NAL Unit type

与 H.264 | AVC 相比，可用 NAL 单元类型的数量已从32 扩展到 64 个。引入此扩展是为了防止将来的扩展缺少可用的 NAL 单元类型。

SPEC 中规范了各种 NAL 单元类型，以对 NAL 单元中包含的信息进行分类。表 5.1 中提供了可用 NAL 单元类型列表。NAL 单元类型可分为两类：视频编码层(VCL) NAL 单元和非 VCL NAL 单元。VCL 类型包括包含实际编码视频数据的所有 NAL 单元。non-VCL 类型包含参数集、分隔符、补充增强信息或填充数据。对于这两个类，都指定了保留的 NAL 单元类型，这些类型可以再 spec 的未来扩展中使用。 NAL 装置类型48、...、63未使用，在 HEVC 规范的未来版本中也将保持 unsepecified 状态。该数字范围可用于专用的外部需求，如新型的 HEVC0 RTP 有效载荷格式。

VCL NAL 单元包含一个 slice 的编码视频数据，该slice 对应于图片定义区域中的一组 CTU。属于同一图片的所有 VCL NAL 单元(因此属于同一访问单元，见下文)必须具有相同的 NAL 单元类型。因此，NAL 单元类型指定图片类型。除了关于图片类型的信息外，NAL 单元类型还提供了关于其它 VCL NAL 单元对当前 NAL 单元的依赖关系的附加信息。以下将重点介绍其中一些方面。

对于不提供随机访问功能的 NAL 单元类型0、...、15,NAL 单元类型的奇偶校验分表表示当前图片在其他图片中的用作或未用作参考。被标记为非参考的 NAL 单元对应于不包括在参考图片列表中的图片。对于与指定的随机接入点图片类型相对应的 NAL 单元类型16、...、21,特定 NAL 单元类型指示是否存在相关联的前导图片。进一步指示如果在随机接入点处开始解码，则这些前导图片是否都是可解码的，或者如果在这里开始解码，则前导图片集是否包括需要跳过的图片。

non-VCL NAL 单元类型包括VPS、SPS 和 PPS，这些参数集包括配置文件/级别信息以及工具配置的所有参数，详情如下。此外，SEI信息以 non-VCL NAL 单元承载。对于 SEI 消息，NAL 单元类型的奇偶性指示 SEI 消息是否需要在接入单元中的最后一个 VCL NAL 单元之前发送(prefix SEI 消息)，或者是否需要在第一个 VCL NAL 单元之后发送(并且可能在最后一个 VCL NAL 单元之后，suffix SEI message)。通常，解码过程不需要 SEI 消息，但对于解码器确定比特流的属性(尤其是在数据丢失的情况下)或传送附加的旁侧信息可能非常有帮助。

提供特定的 NAL 单元类型，用来指示接入单元的边界、视频序列的结束或比特流的结束。虽然此类信息可以从可用的 NAL 单元及其在 NAL 单元流中的顺序中获得，但这些 NAL 单元类型的可用性在无法执行此类分析的系统中是有价值的。

EOS（序列结束）和EOB（比特流结束）NAL 单元除了其终止指示之外，不传送进一步的特定信息。访问单元定界符表示新访问单元的开始，并指示访问单元是仅包含 I slice，或 I Slice 和 P Slice，或是否可能包含 I、P 和 B Slice。

为填充数据定义了一种特殊的 NAL 单元类型。此类型的 NAL 单元可能包含任意数量的 0xFF 字节。例如，对避免缓冲区下溢有严格要求或要求以规定的固定比特率提供视频的系统可以使用填充数据 NAL 单元。

### 5.2.3 Access Units

在前面的章节中，讨论了图片及其属性。这种方法是直观的，因为显示的图片序列构成了可感知的视频。在 NAL 单元和比特流的组织方面，图片的概念没有直接应用。相反，引入了接入单元(Access Units, AUs)的概念。与由 VCL 数据构成的图片相反，访问单元是一组 NAL 单元，包括 VCL 和 non-VCL NAL 单元。

序列中的每个编码图片包含在一组（一个或多个）NAL单元中。访问单元包含与一张图片相关联的所有 NAL 单元。访问单元中的所有 NAL 单元(VCL 和 non-VCL)共享所包含图片的输出时间。注意，根据 SPEC，比特流中的所有 NAL 单元都与访问单元相关联，并且访问单元必须包含编码图片。因此，完整的 NAL 单元流可以被视为接入单元流。

前面章节中讨论了可用图片类型集。这些类型也可用于寻址访问单元。即 BLA 图片包含在 BLA 访问单元中，等等。如上所述，一个 AU (access unit) 内的所有 VCL NAL 单元必须具有相同的 NAL 单元类型。这并不一定意味着它们需要在一张图片中具有相同的 slice 类型。

图 5.3 给出了接入单元中 NAL 单元组织的可视化。SPEC 中也提供了类似的图。AUD（Access Unit Delimiter）可用于指示新访问单元的开始。如果存在，该 NAL 单元必须是接入单元中的第一个 NAL 单元。Prefix SEI NAL 单元可能包含一个或多个 SEI 消息。这些 NAL 单元可能出现在编码 slice  NAL 单元之前，或与编码 Slice NAL Unit 交织，但不得在最后一个 VCL NAL Unit 之后。相反，suffix NAL 单元跟随在 VCL NAL 单元之后。这些不得位于第一个 VCL NAL 单元之前。此外，通过 AUD 指示接入单元的开始的选项、编码视频序列的结束或完整比特流的结束可以分别由 EOS和 EOB NAL 单元指示。这种明确的高级信号可用于解除解码器对相应信息的检测和识别。

AU(Access Unit)中的VCL NAL 单元都需要具有相同的时间标识符tid，该时间标识符 tid 同时是接入单元的 tid。如果数据持续存在并且应用于不同时间层的比特流中的稍后接入单元，则 non-VCL 单元的 tid 可以与当前 AU 中 tid 不同(更高)。例如，这适用于在比特流中发送以供以后激活的PPS或SEI消息。
