# 第五章 High-Level 语法

本章详细介绍了包含编码视频序列的比特流的高级语法和高级组织。第四章描述了编码结构的时空关系和组织，而本章讨论了语法元素及其语义的表示。

高级语法为编码视频数据提供封装，以便进一步处理。它构建了用于传输的信息，并使其可访问和可搜索。它还提供了对所有指定的高级参数和附加辅助信息进行编码的方法。为了在编码信息和表示该信息的形式之间分离，定义了视频编码层(VCL)和网络抽象层(NAL)。所有 VCL 和 非 VCL 数据都封装在 NAL 单元中进行传输。下面将进一步详细介绍这些概念。高级语法方案在概念上继承了H.264 | AVC，并进行了一些修订和扩展，以匹配修改后的需求并实现改进的功能。

## 5.1 Byte Stream Format

与 H.264 | AVC  一样，HEVC 规范提供了一种自包含的字节流格式，用于表示 NAL 单元流。字节流格式在 HEVC 附录 B 中规定。该格式可用于将编码视频数据传输到文件或从文件中传输、或通过网络传输。如果传输层提供其他方式来封装原始 NAL 单元数据，则不需要使用字节流格式。不适用字节流格式的另一种传输类型是实时传输协议(RTP)的有效负载格式。本章提供了HEVC 系统层集成的概述。

在字节流格式中，NAL 单元被编码成字节流。为了使解码器能够从该流中检测和提取 NAL 单元，字节流格式在字节流中的每个 NAL 单元之前指定一个起始代码前缀。起始代码前缀由三个字节(两个零字节和一个'1'字节)组成：start code prefix = 0x00 0x00 0x01 = 0000 0000 0000 0000 0000 0001

如果 NAL 单元是编码视频序列中第一个访问单元的第一个 NAL 单元，或者如果 NAL 单元包含参数集，则在开始代码之前插入额外的 0x00 字节。

如第 5.2.1 节所述，编码器必须防止在字节流的字节对齐位置出现起始代码前缀的字节序列。如果编码数据将产生此字节序列，则插入模拟预防字节。通过扫描字节流中的起始代码前缀，解码器可以确定每个 NAL 单元的起始字节位置，并通过检测最终的尾随零字节，确定 NAL 单元的总大小Nu(以字节为单位)。

## 5.2 Network Abstraction Layer

NAL 定义了用于传输和存储的编码视频数据的封装。编码信息以 NAL 单元组织，NAL 单元包含视频编码层(VCL)的数据或非 VCL 数据。视频编码层包括所有 slice 和 CTU 数据。非 VCL 数据包括参数集和其他信息，详情如下。

表示编码视频序列的所有 VCL 和 non-VCL NAL 单元的有序集合称为 NAL 单元流。根据上下文，NAL 单元流或根据字节流格式的字节流，也称为比特流。

### 5.2.1 NAL Unit Structure

NAL 单元(NALU)的有效负载是 Nu 字节序列。前两个字节包含 NAL 单元头，其余字节称为原始字节序列有效负载(RBSP)。包含编码数据的 RBSP的最后一个字节包括 RBSP 停止位("1")和("0")位，以便实现字节对齐。RBSP 停止位之前的 RBSP 字节位的串联构成数据位串(SODB)。SODB 包含解码过程所需的所有编码数据。在 SODB 中，字节的位从 MSB 连接到 LSB。图 5.1 给出了NAL 单元字节(包括 RBSP 和 SODB)的图示。

SPEC 要求 SODB 断言字节对齐重新同步的能力。因此，可以在比特流中扫描起始码，以找到下一个 NAL 单元的字节对齐的开始。为防止出现起始码，编码器必须在字节对齐位置扫描 RBSP 以查找以下二进制模式：0000 0000 0000 0000 0000 00xx ，其中xx = {00, 01, 10, 11}。然后，必须使用值为'3'的开始代码模拟预防字节修改这些二进制模式：0000 0000 0000 0000 0000 0011 0000 00xx。

根据 SPEC，在 NAL 单元中这样的仿真防止字节可以出现的最早位置是第五个字节(即，在 NAL 单元报头之后的三个字节)。编码器必须声明，考虑到 NAL 单元头的内容，不会发生起始码仿真。

NAL 单元中的字节数 Nu 包含了仿真预防字节。考虑到 RBSP 字节的数量，当从 RBSP 提取 SODB 时，由于这些字节在解码器侧被移除，因此仿真预防字节被排除。解码器必须知道 RBSP 中的字节数，因为它用于停止 slice 级别的熵解码。


