# 第二章 视频编码基本原理

本章主要给出了视频编码基本原理的概述，从视频序列的采集、编码、传输到显示，完整的工具链。主要关注点在编解码处理方面。
这包括视频序列的呈现格式，比如颜色的呈现格式。还有基本概念和混合编码的主要构成部分。本章的主要目的是给出各组件的概念以及不同组件之间是如何交互的。
接下来的章节里，会更加详细的呈现 HEVC 方案中构建模块的具体实现。

## 2.1 视频编码系统

完整的视频编码系统设置可以根据图2.1中的组织。视频编码系统的构建模块包含如下几个：

* 视频采集 - 视频序列的源通常是数字格式的输出。视频采集过程可能与后面的处理步骤，在时间上和空间上分离开来。
* 前处理 - 对未压缩的原始数据进行操作，比如视频裁剪、颜色格式转换、颜色校正和去噪等。
* 编码 - 输入视频序列转换为编码比特流。编码的目的是对输入视频序列生成一个压缩比特流，它适用于特定条件下的传输方式。
* 传输 - 将比特流打包成合适的格式，并在信道中传输。传输包括视频数据的发送和传输到接收端，以及潜在的损失保护和俗世恢复。在某些场景中，比如会议应用中的实时要求，接收端到发送端的反馈是可得的，并且可以用于控制编码器的配置。这类反馈甚至可以用于重新传输，防止信息丢失的情况。
* 解码 - 将接收到的比特流转换为重建视频序列。因为视频编码通常需要有损压缩来达到特定的传输比特率，解码后的视频构成原始视频的近似值。如果传输损失已经不可逆的发生，解码端会采用隐藏策略尽可能的恢复损失的视频。
* 后处理 - 对重建视频序列进行操作以提升或适用与显示。这些操作包括颜色校正、裁剪或者重采样等，或者根据应用执行特定的操作。
* 显示 - 视频序列的呈现用于显示。视频序列需要转换为特定的颜色格式以用于显示。视频序列中图像的输出时间非常重要，已获得预期的视觉印象。

上面描述的处理步骤代表了简单的工具链。在真实的应用中，多前处理/后处理与编解码和传输迭代连接使用。很多应用中，转码技术被应用，输入比特流被转换为带有不同特性的比特流，或者转换为不同视频编码格式的比特流。

### 2.1.1 视频采集

视频序列可以从多种源内获取。这包括自然风景的捕捉、照相胶片材料的扫描、模拟视频的录制、合成生成的视频素材比如计算机生成的动画等。而且，上述视频源的混合和组合也是可能的。根据原始视频材料的源，the signal reveals different characteristic properties concerning the represented scene content as well as the presence of other signal componentswhich interferewith the content, such as camera noise, film grain, motion blur, or artifacts from digitized analogue or physical source material. 在一个简单的单一模型中，获得的视频序列可以描述成未失真的视频信号，被噪声信号增量失真。进一步，视频序列中的非累加伪像可能与相机镜头的特性而导致的扭曲或色彩对准问题。当自然风景被捕捉时，相机属性，例如镜头的结构和分辨率传感器芯片或快门速度对于最红的视频序列特性和图像质量起着重要的作用。

### 2.1.2 前处理

如上节所述，输入视频原素材可能有多种退化以及显示非预期的伪像，这些都应该去除掉。更进一步的预处理操作包括裁剪、几何格式转换、颜色空间格式转换。此外，视频序列被捕捉的速率可能被修改。因为不同的分发方式对应不同的图像速率，图像速率转换时一个非常重要的工作。

在预处理阶段，传入的原始视频素材可能经过多次信号处理和信号增强操作，以便于为后面的视频工具链做准备。对于视频编码，为满足特定应用的需求，可能需要特定的前处理来适应。这包括图像帧率，图像分辨率和图像颜色格式。另外专用的预处理会用到原素材上，以支持编码器实现更高效的压缩效率或者适应视觉印象。适应的操作包括本地低通滤波和去噪滤波。

### 2.1.3 编码

编码阶段将输入的视频序列转换为比特流的编码表示。当代视频编码标准的比特流有个面向分组的结构，编码信息按照采用的规范按照层级结构组织在一起。

编码器必须生成一个为应用需求的比特流。这包括在编码中用到的工具（对应到视频编码标准中特定的层级），或者解码器侧缓冲的约束要求和编码视频的最终比特率。

编码器控制选择的优化是编码器设计中一个非常重要的方面。帧级别上，编码工具的选择和图像的不同区域分配到的不同比特数，都应该考虑到。针对同一个视频编码标准的两个不同编码器实现，可能会生成非常不同的视频质量。

根据用于编码视频的时间不同，用于优化的经历和花费也大不相同。在实时应用中，编码器只能使用正在编码视频的过去信息来适应内容。更进一步，传输需求和其他的不可预测事件影响编码进度。

在制作视频以进行存储和媒体分发的制作系统中，视频处理后主要用于大规模分发到海量客户。此时，视频的离线处理可以使用，对编码器的大量优化工作和参数调优可以进行。

在准备传送到解码端的准备过程中，根据不同应用，编码比特被转换成运输格式。

### 2.1.4 传输

位于图2.1 框图中的传输组件代表将编码的视频序列传输到接收端。该传输可能是实时的甚至是双向的，比如会议应用中。此时，位于发送端和接收端的端到端的延时是关键。在现场直播应用（如体育赛事）中，一定程度的延时通常是可以被忍受的，因为在接收端和发送端没有反馈。在存储和视频分发应用中，传输和分发过程甚至可能是短暂分开的。类似的应用包括视频点播系统，或者存储应用比如DVD和蓝光。

传输系统的设计方面包括所需的可访问性信号。这在多通道应用中非常重要，比如电视中的进入各个频道以及各频道之间的切换非常重要。在对话应用中，多个参与者加入视频会议，组织和分发到指定的与会人端是重要的。在流媒体或者存储应用中，快进、快退、搜索功能通常是需要的。

传输过程中另一个重要的功能是传输信号的鲁棒性，不能丢失、损坏、或者扭曲。在面向数据包的传输方案中，数据包的无错误传送通常是必须的。传输信号的失真包括数据包的丢失。因此防止数据包的丢失和丢失后的可恢复机制的设置是必须的。

### 2.1.5 解码

解码器存储接受到的比特流到一个缓存中，并按照编码器指定的格式，重建编码数据。在标准的视频编码系统中，解码过程遵循规范性程序，正如在基础视频编码规范中。如果没有损失发生，位于解码器输出端的参考帧与编码端的参考帧完全匹配。比特流可能包含部分信息，这是显示的解码视频部分。甚至可能表明完整的解码图像被暂缓显示。

解码器控制中很重要的一点是内存管理，包括解码帧的内存管理和输入码流的内存管理。位于DPB中的解码图像可能用于解码过程中的参考帧。更进一步，在以特定速率显示的系统中，解码流程必须使得解码视频对显示部分是可用的。

以防传输中的数据丢失，解码器需要能够对丢失数据进行处理，并对潜在的意外情况有所措施。这种情况下，错误恢复能力是要有的，解码器必须能够应用错误恢复机制。

### 2.1.6 后处理

从解码器输出的图像可能被送到后处理阶段，该阶段可能进行图像增强处理和显示适配处理。同样的，解码器后处理的错误隐藏方法也会被应用到。

如果解码视频的格式与显示需要的格式不对应，与前处理相似的转换操作就会执行。这包括颜色格式和分辨率或者图像率。

### 2.1.7 显示

显示设备是最终将视频信号呈现到人眼视觉的接口设备。

正如前面提到的那样，并不是所有的编码视频序列的所有样本都在显示端使用或者可获取。例如图像的部分左边界或右边界（或左右边界）在显示区域的外面。如果图像的剩余部分显示在整个屏幕上，这种操作方式称为过扫描。如果编码的帧数比屏幕上显示的样本数少，视频可能会拉长来达到显示分辨率；或者视频的显示不改变，但显示区域不能够覆盖整个区域。这种操作模式称为欠扫描。

视频格式，原材料的颜色空间，和其他有用的信息，may be utile for adequate preparation of the video for display can be signaled with the video data。这类信息称为VUI信息，VUI会在后面 5.7 章节描述。尽管这类信息对于规范的解码流程影响不大，关联这类信息与视频数据本身，能够保证显示的参数传递到解码端。在某些应用场景中，VUI信息可能是固定的，因此在系统中是写死的。

## 2.2 视频序列结构

视频序列包含一系列的图像，连续图像之间呈现固定或动态时间间隔。为得到运动效果，帧率必须达到24帧每秒。最小帧率取决于照明条件和显示内容。帧率的单位是Hz，1Hz = 1s¯1.图像率通常也称为帧率，使用首写字母fps(frames per second)。HD 视频使用50-60Hz的帧率。对于UHD格式，帧率高达120Hz。关于更高帧率的讨论，见【3】。

视频编码的内容是，输入视频序列被编码成比特流，它包含了所有的信息和数据，使得能够在接收端解码比特流并重建输出序列，用于显示。绝大多数视频编码应用，编码视频序列到对应的有损压缩，即解码端的重建视频序列近似于输入视频序列。位于发送端（原始视频序列的被编码）和接收端（包含解码器）的传输，可能是实时的或近似实时的（在视频会话或现场直播场景）。它也可能是非实时的，比如将视频存贮到Blu-ray盘、DVD 中，或在流媒体应用中。

### 2.2.1 图像、帧和场

图像是有强度值的样本的数组。数组中的每个采样，也称之为像素。如果图像是单色图像，它只有一个颜色分量，图像由一组单个采样组成。

## 2.4 混合视频编码方案

自 H.261 以来，混合视频编码方案一直是 ITU-T 和 ISO/IECMPEG 的所有视频编码标准和建议的基本结构。尽管编码结构没有改变，但在过去 25 年中，构建块所代表的算法已经得到了改进，算法的适用配置变得越来越灵活。因为它将视频序列图片之间的时间预测与预测误差的变换编码技术相结合，这种编码方案称为混合编码。

混合视频编码方案已经被证明是一种非常适合将视频信号有效压缩为最小可能大小的比特流的工具。通过对预测误差信号的预测和变换，消除了数据中的冗余信息，并在变换后进行量化，去除了信息中不相关的部分。

混合视频编码方案的基本结构如图 2.8 所示。该图在很大程度上被简化，以使结构和相互依赖性可见。它对应于一个经典的 DPCM 循环：输入视频序列的图片被送入编码器。从输入信号中减去编码器和解码器可用信息生成的预测信号。残差信号（用于表示结果预测误差的）被变换、量化并编码到比特流中。在解码器侧，再现预测信号所需的预测参数也被编码到比特流中。在无差错传输的假设下，编码器和解码器侧是同步的，因为编码器包括解码器的完整预测结构。在图2.8中，编码器和解码器中包含的构建块用灰色框标记。

先前编码的图片可用于要编码的当前图片中的帧间预测。编码器还可以选择使用当前图片内已编码的相邻样本进行帧内预测。视频序列的第一个编码图片只能应用帧内预测，因为没有先前的图片可用。对于之后的图片，编码器基于决策(例如，率失真优化)在两个预测选项之间进行决策。

该过程以基于块的方式操作，其中完整的输入图片被分割成非重叠块，这些块被一个接一个地处理。对于预测信号的构造，首先重构经变换和量化的预测误差，并将其与可用预测相加。然后，该信号由环路滤波器(例如去块滤波器)处理。如果已处理完整图片，则重构图片可用，因为它也在解码器侧。重建图像存储在解码图像缓冲器中，以使其可用于预测。

对于帧间预测，运动估计阶段(ME)在解码图片缓冲器中搜索可用于当前图片块的最佳预测。对于帧内预测，来自当前图片的已重构相邻块的样本值可用于预测。根据编码器决定选择了哪种预测模式，帧内或帧间预测信号用于当前块的预测。

图 2.8 所示的框图不包括编码器控制所需的构建块。编码器实现需要一个控制引擎，该引擎决定合适的预测模式、预测和滤波参数以及合适的量化参数。比特流中还包括用于通知解码器所选预测工具和配置的控制信息。

接下来，简要描述混合视频编码方案的构造块。对图 2.8 中使用的首字母缩略词进行了解释。为简化起见，本说明侧重于 luma 组件。对于色度分量，类似地执行预测和变换编码。

### 2.4.1 图片划分

每个图片被分割成一组完整的非重叠块。图 2.9 显示了图片基本分区。在之前的视频编码规范中，基本块结构是称为宏块的 16x16 luma 样本和相应色度样本。作为宏块概念的推广，编码树块(CTB)被引入 HEVC。它可以分为多个编码块(CBs)。对于预测，每个编码块被划分成一组一个或多个预测块(PB)。并行地，编码块可以被划分为变换块(TB)。

图片可以被分割成一个或多个slices，这些 slice 由整数个 CTB 组成，并且可以独立解码。

### 2.4.2 帧内预测

帧内预测用于去除图片局部区域内的相关性。帧内预测的基本假设是，图片区域的纹理与局部邻域中的纹理相似，因此可以从那里进行预测。

帧内预测的执行是在预测宏块的基础上进行的。在图 2.8 的框图中，它由用于帧内预测的构建块"intra"表示，使用来自所考虑的预测块的重构领域的样本来形成预测信号。当没有用于帧间预测的图片可用时，或者如果帧间预测比合适的帧内预测效率更低或更昂贵时(在合适的成本标准的意义上)，则应用帧内预测。

直接相邻样本（即来自当前块上方采样线的样本和来自当前块左侧重构块的最后一列的样本）通常用于预测。将相邻样本组合，以形成方向或平面预测信号。方向帧内预测的图示如图 2.10 所示。帧内预测的质量和使用频率取决于各个方面。标准包括可用的帧内预测方向、应用前预测样本的潜在预滤波方法，以及其他非方向性预测方法（如DC或平面预测）的可用性。对于帧内预测，适用帧内预测模式的有效信令是必不可少的。可供使用的变体越多，就需要更有效的信令，以便不以预测收益换取信令成本。

### 2.4.4 运动估计

运动估计在预测块级别上操作，并且只是编码器的一部分。估计器使用当前预测块，并尝试在可用参考图片中找到最佳匹配区域。最佳匹配的确定取决于采用的成本标准。


