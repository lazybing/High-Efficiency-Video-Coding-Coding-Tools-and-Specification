# 帧内预测

本章回顾了 HEVC 的帧内编码工具。本章会给出大量可用的预测模式，包括功能描述和示例。此外，详细描述了所应用的帧内预测模式的编码表示。

应用帧内或帧间预测的决定基于 CU ,并且由 CU 的预测模式标志指示。帧内模式下的 CU 由同一 slice 内重建的相邻样本预测。在 I slice 内，仅对 CU 启用帧内预测。在 P 和 B slice 中，CU可以同时处于帧内和帧间预测模式。用作随机访问点的图片仅包含 I slice，因为这些图片不得引用以前的图片。在 P 或 B slice 中，如果未指示来自先前解码的图片的预测，例如对于当前图片中先前不可见的内容，则建议选择帧内模式。

HEVC 中提供了一组35个帧内预测模式，包括DC、Plannar和33个角度预测模式。帧内预测模式的编号如图6.1所示。预测模式2-18表示为水平预测模式，因为预测的主要来源在水平方向。模式19-34相应地表示为垂直预测模式。这些模式可用于从4x4到32x32个样本的预测块大小。对于亮度块和色度块，应用相同的预测模式。对于色度块，省略应用于 luma 帧内预测的一些平滑操作，如下所述。预测参考由于预测块相邻的样本行和样本列构成。使用先前重构块中的可用样本，参考在水平和垂直方向上延伸超过块大小的两倍。

相邻块的可用性可被配置为取决于预测模式。为了获得最佳预测性能，可以应用对来自帧间或帧内预测的相邻块的样本的引用。因此，对于不是只有帧内编码的 slice，引入帧内预测对帧间预测块的依赖性。如果应用要求 P slice 或 B slice中的帧内预测块完全独立，则可以通过图片参数集中的相应标志来配置受约束的帧内预测。激活该标志后，只允许参考先前帧内预测的相邻块，并且消除帧内块对帧间块的任何依赖性。

这可能有助于防止之前损坏的图片在有损环境中传播错误。

## 6.1 预测模式与预测块

CUs 处于帧内模式的情况下，预测单元的含义和表示，不同于帧间模式。对于帧间CUs，预测单元的参数以专用语法结构表示，这种结构不存在于帧内CUs。帧内预测参数在 CU 级别上编码。

如第4.2.4节所述，将 CTU 划分为 CU 会形成方形块的四叉树结构。帧内预测也应用于方形预测块大小。为了限制signaling overhead，用于帧内预测的预测块大小通常对应于编码块大小。针对CU使用合适的帧内预测模式编码。仅对于序列参数集中指定的最小CB大小，可以应用分为四个平方预测块的子分区。在这种情况下，为这些预测块中的每一个提供专用帧内预测模式。由于最小可配置编码块大小为8x8，因此该构造允许使用专用帧内预测模式指示 4x4 帧内预测块。

虽然合适的帧内预测模式与 CB 大小相关，但帧内预测块的合适大小还取决于变换树的划分。正如第4.2.6节所述，变换树将编码块拆分为方形变换块的四叉树。对于帧内预测，标识的CB的帧内预测模式沿着变换树的叶子依次应用于每个变换块。因此，有效预测块大小等于变换块大小。预测和重构的变换块用于预测同一 CB 内的后续变换块。这一概念导致参考样本和预测样本之间可能存在的最小距离。为了提高预测性能和压缩效率，发送信号的代价保持较小。

## 6.2 用于帧内预测的参考样本

在下文中，要进行帧内预测的当前块被称为Bc。假设块有 NcxNc个像素点，其中NC={4,8,16,32,64}，指定导出的预测块大小。参考的样本集由pref表示，Bc 和 pref 中的样本坐标相对于块的左上样本给出。

根据 Nc 和可用的帧内预测模式，可通过平滑滤波对参考样本进行滤波。对于 32x32 的块，可将参考样本集的平滑，可切换为参考样本值的双线性插值，以获得强大的平滑效果。此强滤波器的激活取决于参考样本值的动态范围。此滤波器的使用由序列参考集中的标志控制。

### 6.2.1 参考结构

在水平和垂直方向(加上当前块旁边的左上角相邻角样本)上，用于帧内预测的参考样本集扩展超过 2 * Nc 个样本。图6.2显示了参考样本集的可视化显示。在图中，用于强参考平滑决策的参考样本做了标记。

对于参考样本集Pref的构建，必须测试相邻样本的可用性。图像外的样本和不属于当前块所在 slice 的样本，被标记为不可用。如果样本属于已被帧间编码的块，并且块在PPS中指示约束帧内预测，则这些样本也被标记为不可用。

标记为不可用的参考样本位置，用最接近的可用参考样品值沿Pref填充。如图6.2所示。如果没有参考样本位置可用，则预测样本集Pref将填充编码视频的指定动态范围的中值(即2^（Bd-1）的值，对8bit视频就是128)。

### 6.2.2 低通平滑

### 6.2.3 32×32 Luma参考样本的强平滑

## 6.3 Planar 帧内预测

利用 Planar 平面帧内预测模式，可以近似地表示块中的梯度结构。如图6.4a所示，根据样本的位置，通过四个参考样本的加权平均值生成块预测。预测值可通过如下公式计算：

Bc(x, y) = ((y + 1) / (2 * Nc)) * Pref(-1, Nc) + ((Nc - 1 - x) / (2 * Nc)) * Pref(-1, y) + ((Nc - 1 - y) / (2 * Nc)) * Pref(x, -1) + ((x + 1) / (2 * Nc)) * Pref(Nc, -1).

虽然该预测模式非常适合提供渐进变化的平滑预测信号，但从图6.4b中给出的示例可以看出，它也可用于从样本边界生成水平和垂直结构。


## 6.4 DC 帧内预测

对于 DC 帧内预测，相邻的水平和垂直样本的平均值，可用如下公式获取：V<sub>DC</sub> = (1 / (2 * Nc)) * (∑Pref(x, -1) + ∑Pref(-1, y))

预测块中的样本，被赋值为平均 V<sub>DC</sub> 值。对于 luma 块，将分别处理边界样本(0, 0)、(x, 0)、（0，y）,即块的左边界和上边界处的样本。

在这些位置上，预测值是 V<sub>DC</sub> 和 Pref中相邻值的加权平均值：

Bc(0, 0) = 1/4 * (Pref(-1, 0) + Pref(0, -1) + 2 * V<sub>DC</sub>)  
Bc(x, 0) = 1/4 * (Pref(x, -1) + 3 * V<sub>DC</sub>)  
Bc(0, y) = 1/4 * (Pref(-1, y) + 3 * V<sub>DC</sub>)  

从而，平滑预测块边界。对于色度块，省略这种特殊的边界滤波。luma块的 DC 预测如图6.5所示。

## 6.5 角度帧内预测

对于定向帧内预测，33个帧内预测模式可用，表示从对角线向上到对角线向下的不同预测角度。对于预测角度的定义，定义了32个样本网格上的偏移值Pang。对于垂直预测模式，图6.6显示了Pang与相应好着呢内预测模式的关联。对于水平预测模式，将方案翻转到垂直方向，并相应地分配pang值。如上所述，所有角度预测模式可用于所有适用的帧内预测块大小。他们都使用相同的 32 个样本网格来定义预测角度。




