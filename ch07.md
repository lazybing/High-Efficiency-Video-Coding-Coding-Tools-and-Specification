# 帧间预测

本章介绍 HEVC 中规定的帧间预测工具。帧间预测使用可用的先前重建的图片作为运动补偿的参考。运动补偿预测通常是有效表示视频内容的关键工具。视频序列中的连续图片之间的变换通过当前图片中的区域与在编码器和解码器侧的解码图片缓冲器中可用的先前编码图片之间的逐块位移来近似。由于在图片之间执行运动补偿预测，因此该预测模式被称为帧间预测模式。

运动补偿的运动信息的精度是亮度分量的四分之一样本和色度分量的八分之一样本。本演示文稿的重点在于子样本插值滤波器的设计和运动信息的表示。实现的高级运动矢量推导和运动矢量预测方法对 HEVC 的压缩效率起着关键作用。与先前视频编码规范的内插滤波器相比，子样本内插滤波器在子样本位置提供改进的预测信号。

## 7.1 运动补偿预测

在 HEVC 中，在预测块(PB)级别执行帧间预测。相应的预测单元(PU)包含如何执行帧间预测的信息。帧间预测称为运动补偿预测，因为参考图片的移位区域用于预测当前 PB。参考图片中的区域和当前 PB 之间产生的位移被解释为参考图片和当前图片之间区域的运动。用于编码的位移或运动矢量通常通过应用某些率失真准则来确定，因此这些矢量不一定代表区域的“真实”运动，而是在应用的成本准则的意义上最有效的表示。然而，在此基础上确定的矢量可被视为真实运动的一个近似。本章末尾第 7.4 节提供了 HEVC 运动矢量场的示例。

在 HEVC 中，一个或两个预测器的组合可用于运动补偿预测，类似于先前的标准。在H.264 | AVC 中，关于两个或多个预测器在多假设预测的运动补偿中的应用已经有过研究。在最终的 SPE 设计中，bi预测被选为提高压缩性能和所需实现复杂性之间的最佳折中方案。从多个参考图片获取预测块所需的内存访问量被认为是该上下文中的主要复杂性问题，特别是对于硬件实现。

如上所述，运动矢量以四分之一精度用于亮度帧间预测。对色度应用分量采用相同的运动矢量。由于对于YCbCr 4:2:0 视频，色度分量在两个方向上都进行了下采样（下采样因子为2），因此以1/8采样精度应用于色度运动矢量。如果运动矢量（MV）指向图片区域之外，则应用恒定边界延伸。为此，将相应行或列中最后一个样本的值分配到图片外部的相应位置，如图 7.1 所示。

### 7.1.1 单预测和双预测

可以使用一个或两个参考图片作为预测源来执行运动补偿预测。可用预测源的数量取决于当前 PU 所属 slice 的slice 类型。在 P slice 中，只有一个预测参考可用于帧间预测，从而启用 PB 的单预测。在此，编码器可以选择参考图片列表 0 中的一个可用参考图片，如第 4.3.2 节所述。在 B slice 中，可以应用一个或两个预测源，它有两个参考图片列表可用。可以使用来自两个列表中的每个列表的单个预测或预测的组合。这里，单预测的执行可能来自参考图像列表 0 或参考图片列表 1。对于双预测，使用来自每个列表的一个参考图片。无论单预测还是双预测，预测块的构造可以通过为每个可用预测源配置权重和附加偏移值来进一步控制。下面将进一步详细介绍这种加权预测的概念。

图 7.2 描述了单预测和双预测可用变化的选择。参考图片集(RPS)的大小和结构以及适用参考图片列表的构造取决于编码器，而编码流的目标 profile 和 level 会对此进行限制。一张图片可以在两个参考图片列表中列出，这允许对 PB 应用来自同一参考图片的两个预测器。如果认为有益的话，这可以用于实际提高运动矢量精度。例如，来自同一参考图片的仅相距1/4采样位置的两个运动矢量的加权预测，可以解释为1/8采样精度应用联合运动矢量。

### 7.1.2 将块划分为预测块的编码

帧间或帧内编码的决定是基于 CU 做出的。对于帧间 CUs，对应的编码块被进一步划分为一个或多个预测块。第 4.2.5 节讨论了 CB 到 PBs 的可用分区。图 7.3 给出了可用的分区间类型。对于 B slice 中的每个 PB，可以根据编码器决策选择单预测或双预测的应用。除了使用 H.264 中已知的分区类型（将 CB 按照对称规则划分到 PB）外，HEVC 还允许额外的四个非对称分区，如图 7.3 所示。这些分区类型称为非对称运动分区(AMP)。例如，在一个编码块区域内，前景对象和背景部分重叠的情况下，AMP 可用于这类情景的有效分区表示。使用对称分区的等效表示将需要相应 CB 和 PB 结构的更多信令开销。该问题的描述如图 7.4 所示。AMP 的使用可以通过 SPS 中对应的标志进行配置。

运动补偿的最小块大小为 4x8 和 8x4。因此，排除了与 4x4 块的相互预测。出于解码器复杂性的原因引入了该限制，以减少不同运动补偿操作的最大可能数量。

### 7.1.3 加权预测

加权预测可作为 P 或 B slice 预测的工具。对于每个参考图片，加权因子和偏移值可以被赋值；如果执行来自参考图片的运动补偿预测，将应用这些赋值。

在 P slice 中，加权预测可被用于色度分量的淡入或淡出强度。在 B slice中，可以另外使用加权预测来混合来自两个参考图片的预测。

对于 P slice 和 B slice 中，加权预测的应用由 PPS 中的标志位控制。如果这两个参数中的任何一个被激活，则加权预测参数将被编码到 slice segment header 中。对参考图片列表中每个图片的亮度和色度的偏移值和权重单独编码。对于 P  slice，如果相应的 PPS 标志关闭，则不应用加权预测。对于 B slice，该标志在具有隐士和显式权重的预测之间切换。如果该标志为管，则应用具有来自不同参考图片的两个预测块的相等权重的隐世加权。否则，将使用编码的显式权重。

## 7.4 帧间编码示例

图 7.11 和 图 7.12 显示了JCT-VC 通用测试条件下，测试序列中用四个 CTBs 的帧间编码示例。图 7.11 给出了CTBs 划分为 CBs 和 PBs、参考索引在块上的分布，以及skip、merge 模式和预测运动矢量编码的分配。该示例显示，所描述区域的重要部分使用 skip 或 merge 模式进行编码，其中除了应用的 merge 索引外，不传输进一步的运动信息。图 7.12 显示了具有相应运动矢量预测器和运动矢量差的运动矢量。从图中可以看出，在给定示例中，只需要对较小的运动矢量差进行编码。还可以进一步看出，列表 0 和 列表 1 的运动向量倾向于朝向大致相反的方向。这是因为列表 0 的参考图像参考先前的图片，而列表 1 参考按显示顺序跟随当前图片的图片。

所示场景还包括覆盖场景中人员运动的相机运动。为了便于说明，图 7.13 描述了完整图片的运动矢量。

## 7.5 与 H.264 | AVC 比较

为了与 H.264 | AVC 进行比较，以下重点介绍了两个主要方面：运动信息的表示和编码方式，以及各子样本插值过程的设计和特点。

### 7.5.1 运动矢量表示法

H.264 和 HEVC 都对亮度分量中的运动补偿采用四分之一采样精度，对色度分量中的运动补偿采用八分之一采样精度。HEVC 中的运动矢量表示比 H.264 中的表示更复杂，这导致 HEVC 中的运动信息的表示更紧凑。

在 H.264 | AVC 中，直接模式应用于当前块的衍生运动矢量，而不是发送它。这种模式仅在 B slice 中可用，并应用于 bi 预测。指定了直接模式运动矢量推导的两种变体：在空间直接模式中，应用运动矢量从由相邻样本A、B、C识别的三个相邻块的运动矢量的主题中推导，如图 7.14 所示；在时间直接模式中，运动矢量从参考图片中的并置块导出。HEVC Merge 模式可以解释为直接模式的推广。通过从相邻块继承合并的运动信息，可以非常有效地编码图片中几乎任意形状区域的恒定运动。

对于运动矢量预测，使用与图 7.14 所示的空间 Direct 模式中相同的预测器块，应用空间相邻块的运动矢量的中值。将导出的预测器添加到编码的运动矢量差中，以形成适用的运动矢量。与合并模式和直接模式类似，HEVC的高级运动矢量预测可以看作是H.264 | AVC中运动矢量预测的推广。在HEVC中，从两个可用的预测器和更大的预测器候选集合中进行选择的选项提高了方案的编码效率。

应当注意的是，在H.264 | AVC中，使用4×4采样网格访问用于时间直接模式的参考图片的运动向量。因此，与仅在16×16采样网格上提供运动矢量存储的HEVC相比，必须存储以供使用时间直接模式访问的运动矢量的数量要大得多。作为进一步的差异，H.264 | AVC需要一个行缓冲器来存储编码的运动矢量差异，因为CABAC上下文选择需要相邻差异之和。

### 7.5.2 子样本插值
